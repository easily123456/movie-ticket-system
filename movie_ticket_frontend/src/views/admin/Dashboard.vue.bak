<template>
  <div class="dashboard-page">
    <!-- 页面标题 -->
    <div class="page-header">
      <h1 class="page-title">仪表盘</h1>
      <div class="header-actions">
        <el-button type="primary" :icon="Refresh" @click="refreshData">
          刷新数据
        </el-button>
      </div>
    </div>
    <!-- 数据统计卡片 -->
    <section class="stats-cards">
      <el-row :gutter="20">
        <el-col :xs="24" :sm="12" :md="6" :lg="6">
          <StatCard
            title="总用户数"
            :value="stats.totalUsers"
            icon="User"
            color="#409EFF"
            :loading="loading"
          />
        </el-col>
        <el-col :xs="24" :sm="12" :md="6" :lg="6">
          <StatCard
            title="总电影数"
            :value="stats.totalMovies"
            icon="Film"
            color="#67C23A"
            :loading="loading"
          />
        </el-col>
        <el-col :xs="24" :sm="12" :md="6" :lg="6">
          <StatCard
            title="总订单数"
            :value="stats.totalOrders"
            icon="Document"
            color="#E6A23C"
            :loading="loading"
          />
        </el-col>
        <el-col :xs="24" :sm="12" :md="6" :lg="6">
          <StatCard
            title="今日收入"
            :value="formatPrice(stats.todayRevenue)"
            icon="Money"
            color="#F56C6C"
            :loading="loading"
          />
        </el-col>
      </el-row>
    </section>
    <!-- 图表区域 -->
    <section class="charts-section">
      <el-row :gutter="20">
        <!-- 收入趋势图 -->
        <el-col :xs="24" :lg="16">
          <el-card class="chart-card">
            <template #header>
              <div class="chart-header">
                <span class="chart-title">收入趋势</span>
                <div class="chart-actions">
                  <el-radio-group v-model="revenueRange" size="small" @change="loadRevenueData">
                    <el-radio-button label="week">本周</el-radio-button>
                    <el-radio-button label="month">本月</el-radio-button>
                    <el-radio-button label="year">本年</el-radio-button>
                  </el-radio-group>
                </div>
              </div>
            </template>
            <div v-loading="revenueLoading" class="chart-container">
              <div ref="revenueChart" class="chart" style="height: 300px;"></div>
            </div>
          </el-card>
        </el-col>
        <!-- 订单分布 -->
        <el-col :xs="24" :lg="8">
          <el-card class="chart-card">
            <template #header>
              <span class="chart-title">订单状态分布</span>
            </template>
            <div v-loading="orderStatsLoading" class="chart-container">
              <div ref="orderChart" class="chart" style="height: 300px;"></div>
            </div>
          </el-card>
        </el-col>
      </el-row>
    </section>
    <!-- 数据表格区域 -->
    <section class="tables-section">
      <el-row :gutter="20">
        <!-- 热门电影排行 -->
        <el-col :xs="24" :lg="12">
          <el-card class="table-card">
            <template #header>
              <div class="table-header">
                <span class="table-title">热门电影排行</span>
                <el-button link type="primary" @click="$router.push({ name: 'movies' })">
                  查看全部
                </el-button>
              </div>
            </template>
            <div v-loading="hotMoviesLoading">
              <el-table :data="hotMovies" style="width: 100%">
                <el-table-column label="电影名称" min-width="200">
                  <template #default="{ row }">
                    <div class="movie-info">
                      <el-image
                        :src="row.posterUrl"
                        :alt="row.title"
                        class="movie-poster"
                        fit="cover"
                      >
                        <template #error>
                          <div class="image-slot">
                            <el-icon><Picture /></el-icon>
                          </div>
                        </template>
                      </el-image>
                      <div class="movie-details">
                        <div class="movie-title">{{ row.title }}</div>
                        <div class="movie-meta">
                          <el-rate
                            v-model="row.rating"
                            disabled
                            show-score
                            text-color="#ff9900"
                            score-template="{value}"
                            size="small"
                          />
                        </div>
                      </div>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="类型" prop="genreName" width="100" />
                <el-table-column label="评分" width="100">
                  <template #default="{ row }">
                    <span class="rating">{{ row.rating?.toFixed(1) }}</span>
                  </template>
                </el-table-column>
                <el-table-column label="收藏数" prop="favoriteCount" width="80" />
              </el-table>
            </div>
          </el-card>
        </el-col>
        <!-- 最近订单 -->
        <el-col :xs="24" :lg="12">
          <el-card class="table-card">
            <template #header>
              <div class="table-header">
                <span class="table-title">最近订单</span>
                <el-button link type="primary" @click="$router.push({ name: 'order-management' })">
                  查看全部
                </el-button>
              </div>
            </template>
            <div v-loading="recentOrdersLoading">
              <el-table :data="recentOrders" style="width: 100%">
                <el-table-column label="订单号" min-width="180">
                  <template #default="{ row }">
                    <span class="order-no">{{ row.orderNo }}</span>
                  </template>
                </el-table-column>
                <el-table-column label="用户" prop="username" width="100" />
                <el-table-column label="金额" width="100">
                  <template #default="{ row }">
                    <span class="price">{{ formatPrice(row.totalPrice) }}</span>
                  </template>
                </el-table-column>
                <el-table-column label="状态" width="100">
                  <template #default="{ row }">
                    <el-tag :type="getOrderStatusType(row.status)" size="small">
                      {{ getOrderStatusText(row.status) }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="时间" width="140">
                  <template #default="{ row }">
                    <span class="time">{{ formatTime(row.createTime) }}</span>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </el-card>
        </el-col>
      </el-row>
    </section>
    <!-- 快捷操作 -->
    <section class="quick-actions">
      <el-card>
        <template #header>
          <span class="section-title">快捷操作</span>
        </template>
        <div class="actions-grid">
          <el-button
            type="primary"
            :icon="Plus"
            @click="$router.push({ name: 'movie-create' })"
          >
            新增电影
          </el-button>
          <el-button
            type="success"
            :icon="VideoPlay"
            @click="$router.push({ name: 'sessions' })"
          >
            排片管理
          </el-button>
          <el-button
            type="warning"
            :icon="Edit"
            @click="$router.push({ name: 'news-management' })"
          >
            发布资讯
          </el-button>
          <el-button
            type="info"
            :icon="User"
            @click="$router.push({ name: 'user-management' })"
          >
            用户管理
          </el-button>
        </div>
      </el-card>
    </section>
  </div>
</template>
<script setup>
import { ref, reactive, onMounted, onUnmounted, nextTick } from 'vue'
// import { useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'
import * as echarts from 'echarts'
import {
  Refresh,
  Plus,
  VideoPlay,
  Edit,
  User,
  Picture
} from '@element-plus/icons-vue'
import { formatPrice, formatTime } from '@/utils'
import { useAdminStore } from '@/stores/admin'
import StatCard from '@/components/admin/StatCard.vue'

defineOptions({
  name: 'AdminDashboard'
})
// const router = useRouter()
const adminStore = useAdminStore()

// 响应式数据
const loading = ref(false)
const revenueLoading = ref(false)
const orderStatsLoading = ref(false)
const hotMoviesLoading = ref(false)
const recentOrdersLoading = ref(false)

const revenueRange = ref('week')

const stats = reactive({
  totalUsers: 0,
  totalMovies: 0,
  totalOrders: 0,
  todayRevenue: 0,
  monthlyRevenue: 0
})

const hotMovies = ref([])
const recentOrders = ref([])

// 图表实例
let revenueChart = null
let orderChart = null

// 图表DOM引用
const revenueChartRef = ref()
const orderChartRef = ref()

onMounted(async () => {
  await loadDashboardData()
  initCharts()
  window.addEventListener('resize', handleResize)
})

onUnmounted(() => {
  if (revenueChart) {
    revenueChart.dispose()
  }
  if (orderChart) {
    orderChart.dispose()
  }
  window.removeEventListener('resize', handleResize)
})

// 加载仪表盘数据
const loadDashboardData = async () => {
  loading.value = true
  try {
    // 加载统计数据
    const statsData = await adminStore.getDashboardStats()
    Object.assign(stats, statsData)

    // 并行加载其他数据
    await Promise.all([
      loadHotMovies(),
      loadRecentOrders(),
      loadRevenueData(),
      loadOrderStats()
    ])
  } catch (error) {
    ElMessage.error('加载仪表盘数据失败')
    console.error('加载仪表盘数据失败:', error)
  } finally {
    loading.value = false
  }
}

// 加载热门电影
const loadHotMovies = async () => {
  hotMoviesLoading.value = true
  try {
    // 这里调用获取热门电影的API
    // hotMovies.value = await adminStore.getHotMovies()

    // 临时模拟数据
    hotMovies.value = [
      {
        id: 1,
        title: '流浪地球3',
        posterUrl: '/images/poster1.jpg',
        genreName: '科幻',
        rating: 4.8,
        favoriteCount: 1234
      },
      {
        id: 2,
        title: '热辣滚烫',
        posterUrl: '/images/poster2.jpg',
        genreName: '喜剧',
        rating: 4.5,
        favoriteCount: 987
      }
    ]
  } catch (error) {
    console.error('加载热门电影失败:', error)
  } finally {
    hotMoviesLoading.value = false
  }
}

// 加载最近订单
const loadRecentOrders = async () => {
  recentOrdersLoading.value = true
  try {
    // 这里调用获取最近订单的API
    // recentOrders.value = await adminStore.getRecentOrders()

    // 临时模拟数据
    recentOrders.value = [
      {
        id: 1,
        orderNo: 'ORD202401150001',
        username: 'user1',
        totalPrice: 120.00,
        status: 'PAID',
        createTime: new Date()
      },
      {
        id: 2,
        orderNo: 'ORD202401150002',
        username: 'user2',
        totalPrice: 80.00,
        status: 'PENDING',
        createTime: new Date(Date.now() - 30 * 60 * 1000)
      }
    ]
  } catch (error) {
    console.error('加载最近订单失败:', error)
  } finally {
    recentOrdersLoading.value = false
  }
}

// 加载收入数据
const loadRevenueData = async () => {
  revenueLoading.value = true
  try {
    // 这里根据时间范围调用不同的API
    // const revenueData = await adminStore.getRevenueData(revenueRange.value)

    // 临时模拟数据
    const revenueData = generateMockRevenueData()
    updateRevenueChart(revenueData)
  } catch (error) {
    console.error('加载收入数据失败:', error)
  } finally {
    revenueLoading.value = false
  }
}

// 加载订单统计
const loadOrderStats = async () => {
  orderStatsLoading.value = true
  try {
    // const orderStats = await adminStore.getOrderStats()

    // 临时模拟数据
    const orderStats = {
      pending: 15,
      paid: 120,
      cancelled: 8,
      refunded: 5
    }
    updateOrderChart(orderStats)
  } catch (error) {
    console.error('加载订单统计失败:', error)
  } finally {
    orderStatsLoading.value = false
  }
}

// 初始化图表
const initCharts = () => {
  nextTick(() => {
    if (revenueChartRef.value) {
      revenueChart = echarts.init(revenueChartRef.value)
    }
    if (orderChartRef.value) {
      orderChart = echarts.init(orderChartRef.value)
    }
  })
}

// 更新收入图表
const updateRevenueChart = (data) => {
  if (!revenueChart) return

  const option = {
    tooltip: {
      trigger: 'axis',
      formatter: '{b}<br/>￥{c}'
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: data.dates,
      axisLine: {
        lineStyle: {
          color: '#E4E7ED'
        }
      },
      axisLabel: {
        color: '#606266'
      }
    },
    yAxis: {
      type: 'value',
      axisLine: {
        show: true,
        lineStyle: {
          color: '#E4E7ED'
        }
      },
      axisLabel: {
        formatter: '￥{value}',
        color: '#606266'
      },
      splitLine: {
        lineStyle: {
          color: '#F2F6FC',
          type: 'dashed'
        }
      }
    },
    series: [
      {
        name: '收入',
        type: 'line',
        data: data.values,
        smooth: true,
        symbol: 'circle',
        symbolSize: 6,
        lineStyle: {
          color: '#409EFF',
          width: 3
        },
        itemStyle: {
          color: '#409EFF',
          borderColor: '#fff',
          borderWidth: 2
        },
        areaStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 0, color: 'rgba(64, 158, 255, 0.3)' },
            { offset: 1, color: 'rgba(64, 158, 255, 0.1)' }
          ])
        }
      }
    ]
  }

  revenueChart.setOption(option)
}

// 更新订单图表
const updateOrderChart = (data) => {
  if (!orderChart) return

  const option = {
    tooltip: {
      trigger: 'item',
      formatter: '{a} <br/>{b}: {c} ({d}%)'
    },
    legend: {
      orient: 'vertical',
      right: 10,
      top: 'center',
      data: ['待支付', '已支付', '已取消', '已退款']
    },
    series: [
      {
        name: '订单状态',
        type: 'pie',
        radius: ['50%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 10,
          borderColor: '#fff',
          borderWidth: 2
        },
        label: {
          show: false,
          position: 'center'
        },
        emphasis: {
          label: {
            show: true,
            fontSize: 18,
            fontWeight: 'bold'
          }
        },
        labelLine: {
          show: false
        },
        data: [
          { value: data.pending, name: '待支付', itemStyle: { color: '#E6A23C' } },
          { value: data.paid, name: '已支付', itemStyle: { color: '#67C23A' } },
          { value: data.cancelled, name: '已取消', itemStyle: { color: '#909399' } },
          { value: data.refunded, name: '已退款', itemStyle: { color: '#F56C6C' } }
        ]
      }
    ]
  }

  orderChart.setOption(option)
}

// 生成模拟收入数据
const generateMockRevenueData = () => {
  const dates = []
  const values = []

  const now = new Date()
  for (let i = 6; i >= 0; i--) {
    const date = new Date(now)
    date.setDate(date.getDate() - i)
    dates.push(formatTime(date, 'MM-DD'))
    values.push(Math.floor(Math.random() * 10000) + 5000)
  }

  return { dates, values }
}

// 窗口大小变化处理
const handleResize = () => {
  if (revenueChart) {
    revenueChart.resize()
  }
  if (orderChart) {
    orderChart.resize()
  }
}

// 刷新数据
const refreshData = () => {
  loadDashboardData()
  ElMessage.success('数据已刷新')
}

// 订单状态相关方法
const getOrderStatusType = (status) => {
  const typeMap = {
    PENDING: 'warning',
    PAID: 'success',
    CANCELLED: 'info',
    REFUNDED: 'danger'
  }
  return typeMap[status] || 'info'
}

const getOrderStatusText = (status) => {
  const textMap = {
    PENDING: '待支付',
    PAID: '已支付',
    CANCELLED: '已取消',
    REFUNDED: '已退款'
  }
  return textMap[status] || status
}
</script>
<style scoped lang="scss">
.dashboard-page {
  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: $spacing-xl;

    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: $text-primary;
      margin: 0;
    }
  }
}

.stats-cards {
  margin-bottom: $spacing-xl;
}

.charts-section {
  margin-bottom: $spacing-xl;

  .chart-card {
    height: 400px;

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chart-title {
      font-weight: 600;
      color: $text-primary;
    }

    .chart-container {
      height: 300px;
    }
  }
}

.tables-section {
  margin-bottom: $spacing-xl;

  .table-card {
    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .table-title {
      font-weight: 600;
      color: $text-primary;
    }
  }
}

.movie-info {
  display: flex;
  align-items: center;
  gap: $spacing-md;

  .movie-poster {
    width: 40px;
    height: 60px;
    border-radius: $border-radius-small;
    flex-shrink: 0;
  }

  .movie-details {
    flex: 1;
    min-width: 0;

    .movie-title {
      font-weight: 500;
      color: $text-primary;
      margin-bottom: $spacing-xs;
      @include text-ellipsis;
    }

    .movie-meta {
      display: flex;
      align-items: center;
      gap: $spacing-xs;
    }
  }
}

.order-no {
  font-family: 'Monaco', 'Consolas', monospace;
  color: $text-regular;
}

.price {
  font-weight: 600;
  color: $primary-color;
}

.rating {
  font-weight: 600;
  color: #E6A23C;
}

.time {
  color: $text-secondary;
  font-size: $font-size-small;
}

.quick-actions {
  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: $spacing-lg;

    .el-button {
      height: 80px;
      font-size: 16px;
      font-weight: 500;

      .el-icon {
        font-size: 24px;
        margin-bottom: $spacing-xs;
      }
    }
  }
}

// 响应式设计
@media (max-width: $breakpoint-sm) {
  .charts-section .chart-card,
  .tables-section .table-card {
    height: auto;
  }

  .quick-actions .actions-grid {
    grid-template-columns: 1fr;
  }
}
</style>
